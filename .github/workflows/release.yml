name: Build and Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  test:
    name: Run tests before release
    uses: ./.github/workflows/test.yml

  build:
    needs: test
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            binary_name: tina
            quick_binary_name: tina-quick
            artifact_name: tina-linux-x86_64
            quick_artifact_name: tina-quick-linux-x86_64
          - os: windows-latest
            binary_name: tina.exe
            quick_binary_name: tina-quick.exe
            artifact_name: tina-windows-x86_64.exe
            quick_artifact_name: tina-quick-windows-x86_64.exe
          - os: macos-latest
            binary_name: tina
            quick_binary_name: tina-quick
            artifact_name: tina-macos-x86_64
            quick_artifact_name: tina-quick-macos-x86_64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true
          cache-dependency-glob: "pyproject.toml"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          uv sync
          uv add --group dev pyinstaller

      - name: Build main executable (Linux/macOS)
        if: runner.os != 'Windows'
        run: uv run pyinstaller --clean scripts/tina.spec

      - name: Build quick executable (Linux/macOS)
        if: runner.os != 'Windows'
        run: uv run pyinstaller --clean scripts/tina-quick.spec

      - name: Build main executable (Windows)
        if: runner.os == 'Windows'
        run: uv run pyinstaller --clean scripts/tina.spec

      - name: Build quick executable (Windows)
        if: runner.os == 'Windows'
        run: uv run pyinstaller --clean scripts/tina-quick.spec

      - name: Upload binaries to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-binaries
          path: |
            dist/${{ matrix.binary_name }}
            dist/${{ matrix.quick_binary_name }}

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets

          # Linux
          if [ -f artifacts/ubuntu-latest-binaries/tina ]; then
            mv artifacts/ubuntu-latest-binaries/tina release-assets/tina-linux-x86_64
            chmod +x release-assets/tina-linux-x86_64
          fi
          if [ -f artifacts/ubuntu-latest-binaries/tina-quick ]; then
            mv artifacts/ubuntu-latest-binaries/tina-quick release-assets/tina-quick-linux-x86_64
            chmod +x release-assets/tina-quick-linux-x86_64
          fi

          # Windows
          if [ -f artifacts/windows-latest-binaries/tina.exe ]; then
            mv artifacts/windows-latest-binaries/tina.exe release-assets/tina-windows-x86_64.exe
          fi
          if [ -f artifacts/windows-latest-binaries/tina-quick.exe ]; then
            mv artifacts/windows-latest-binaries/tina-quick.exe release-assets/tina-quick-windows-x86_64.exe
          fi

          # macOS
          if [ -f artifacts/macos-latest-binaries/tina ]; then
            mv artifacts/macos-latest-binaries/tina release-assets/tina-macos-x86_64
            chmod +x release-assets/tina-macos-x86_64
          fi
          if [ -f artifacts/macos-latest-binaries/tina-quick ]; then
            mv artifacts/macos-latest-binaries/tina-quick release-assets/tina-quick-macos-x86_64
            chmod +x release-assets/tina-quick-macos-x86_64
          fi

          ls -lah release-assets/

      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sed -n '2p')

          if [ -z "$PREV_TAG" ]; then
            echo "changelog=Initial release" >> $GITHUB_OUTPUT
          else
            echo "changelog<<EOF" >> $GITHUB_OUTPUT
            git log ${PREV_TAG}..HEAD --pretty=format:"- %s" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          body: ${{ steps.changelog.outputs.changelog }}
          files: release-assets/*
          fail_on_unmatched_files: true
